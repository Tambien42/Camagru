{% extends "base.html" %}

{% block title %}Snapshot{% endblock %}

{% block style %}
	#video, #photos
	{
	    transform: rotateY(180deg);
	    -webkit-transform:rotateY(180deg); /* Safari and Chrome */
	    -moz-transform:rotateY(180deg); /* Firefox */
	}
{% endblock %}

{% block body %}
	<div class="container">
		<div class="">
			<h1>Snapshot</h1>
			<p>Take a picture.</p>
		</div>
		<div class="top-container">
			<div class="video-container">
				<video id="video">
					Stream not available.
				</video>
			</div>
			<div class="">
				<button id="photo-button" class="btn btn-dark">Take Photo</button>
				<select name="" id="photo-filter" class="select">
					<option value="none">Normal</option>
					<option value="grayscale(100%)">Grayscale</option>
					<option value="sepia(100%)">Sepia</option>
					<option value="invert(100%)">Invert</option>
					<option value="hue-rotate(90deg)">Hue</option>
					<option value="blur(10px)">Blur</option>
					<option value="contrast(200%)">Contrast</option>
				</select>
				<button id="clear-button" class="btn btn-light">Clear</button>
			</div>
			<div class="">
				<canvas id="canvas" width="300" height="300"></canvas>
			</div>
		</div>
		<div class="bottom-container">
			<div id="photos"></div>
		</div>
	</div>

	<script>
		//--------------------
		// GET USER MEDIA CODE
		//--------------------
		// Global variables
		let width = 500,
			height = 0,
			filter = 'none',
			streaming = false;
		window.onload = function() {
			// DOM elements
			const video = document.getElementById('video');
			const canvas = document.getElementById('canvas');
			const photos = document.getElementById('photos');
			const photoButton = document.getElementById('photo-button');
			const clearButton = document.getElementById('clear-button');
			const photoFilter = document.getElementById('photo-filter');
			const modal = document.getElementById('open-modal');

			// Get Media Stream
			navigator.mediaDevices.getUserMedia({video: true, audio: false})
				.then(function(stream) {
					// Link to the video source
					video.srcObject = stream;
					// Play video
					video.play();
				})
				.catch(function(err) {
					console.log(`Error : ${err}`);
				});

			// Play when ready
			video.addEventListener('canplay', function (e) {
				if (!streaming) {
					// Set video canvas height
					height = video.videoHeight / (video.videoWidth / width);
					video.setAttribute('width', width);
					video.setAttribute('height', height);
					canvas.setAttribute('width', width);
					canvas.setAttribute('height', height);

					streaming = true;
				}
			}, false);

			// Photo Button event
			photoButton.addEventListener('click', function(e) {
				console.log('test');
					takePicture();
					e.preventDefault();
			}, false);

			// Filter event
			photoFilter.addEventListener('change', function(e) {
				// Set filter to chosen option
				filter = e.target.value;
				// Set filter to video
				video.style.filter = filter;
				e.preventDefault();
			});

			// Clear event
			clearButton.addEventListener('click', function() {
				// Clear Photos
				photos.innerHTML = '';
				// Change filter to normal
				filter = 'none';
				video.style.filter = filter;
				// Reset select list
				photoFilter.selectedIndex = 0;
			})
		};

	//---------------------
	// TAKE A SNAPSHOT CODE
	//---------------------
	function takePicture() {
		// Create canvas
		const context = canvas.getContext('2d');
		// Clear Photos
		photos.innerHTML = '';

		if (width && height) {
			// Set canvas props
			canvas.width = width;
			canvas.height = height;
			// Draw an image of the video on the canvas
			context.drawImage(video, 0, 0, width, height);
			// Create an image from the canvas
			const imgUrl = canvas.toDataURL('image/png');
			// Create image element
			const image = document.createElement('img');
			// Set image source
			image.setAttribute('src', imgUrl);
			// Set image filter
			image.style.filter = filter;
			// Add image to photo id
			photos.appendChild(image);
		}
	}
	</script>

{% endblock %}
